<div id="loader">
	<div id='preview_container' class='cover_contain blur'></div>
	<div id='btnLoad'></div>
	<div id='label__not-found'></div>
</div>
<div id="3dinterface" class='interface3d'>
	<div id='ui'>
		<div id='bottom_bar'></div>
	</div>
	<div id="3dcontainer" class='container3d'></div>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156196140-2"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-156196140-2');
</script>
<script>
var stylesheet = document.createElement("link");
stylesheet.rel = "stylesheet";
stylesheet.href = "/stylesheets/viewer.css";
document.head.appendChild(stylesheet);
var isFullscreen = false;
var pStat = {};
var mapMod = "";

loadInitializer();

$( '#prod_initializer' ).on( 'load', function() {
	startPage();
});

function loadInitializer() {
	if( product != "Not Found" && product != "" ) {
		if( typeof(product) !== "object" )
			product = JSON.parse(product);

		if( product.viewerVersion !== undefined ) {
			viewerVersion = product.viewerVersion;
		}

		//Load modules
		if ( product.modelFile._text ) loadScript("_text");
		if ( jQuery.isPlainObject(product.modelFile) && Object.keys(product.modelFile).length > 1 ) loadScript("_multipart");
		if ( product.AR && product.AR.enable ) loadScript ("_ar");
		if ( queryParams.font ) loadScript("_font");

		$('#prod_initializer').attr('src', "/javascripts/productInitializer.js");
	} else {
		$( '#label__not-found' ).append("Not Found");
		$( '#label__not-found' ).fadeIn();
		$( '#btnLoad' ).remove();
		$( '.container3d' ).addClass( 'gradient' );
	}
}

function loadScript(moduleScript) {
	var script = document.createElement("script");
	script.src = "/javascripts/" + moduleScript + ".js";

	document.body.appendChild(script);
	return script
}

function startPage() {

	pStat["start"] = performance.now();

	// Overwrite product settings with URL parameters and set setting defaults
	// General
	if ( !product.general ) { product.general = {} }
	if ( typeof queryParams.id == 'string' ) { productID = queryParams.id }
	if ( product.name ) {moveSetting( ['general','name'], ['name'] )}
	product.general.viewerVersion = viewerVersion;


	// Viewer
	if ( !product.viewer ) { product.viewer = {} }

	if ( product.optional.autoload ) {moveSetting( ['viewer','autoload'], ['optional','autoload'] )}
	product.viewer.autoload = Boolean(JSON.parse((typeof queryParams.autoload == 'string') ? queryParams.autoload : (product.viewer.autoload != undefined) ? product.viewer.autoload : true));

	if ( product.optional.hideInfo ) {moveSetting( ['viewer','hideInfo'], ['optional','hideInfo'] )}
	product.viewer.hideInfo = Boolean(JSON.parse((typeof queryParams.hideInfo == 'string') ? queryParams.hideInfo : (product.viewer.hideInfo != undefined) ? product.viewer.hideInfo : true));

	if ( product.optional.hideFullscreen ) {moveSetting( ['viewer','hideFullscreen'], ['optional','hideFullscreen'] )}
	product.viewer.hideFullscreen = Boolean(JSON.parse((typeof queryParams.hideFullscreen == 'string') ? queryParams.hideFullscreen : (product.viewer.hideFullscreen != undefined) ? product.viewer.hideFullscreen : false));

	if ( product.optional.hideLogos ) {moveSetting( ['viewer','hideLogos'], ['optional','hideLogos'] )}
	product.viewer.hideLogos = Boolean(JSON.parse(( product.viewer.hideLogos != undefined ) ? product.viewer.hideLogos : false));

	if ( product.optional.touch3D ) {moveSetting( ['viewer','touch3D'], ['optional','touch3D'] )}
	product.viewer.touch3D = Boolean(JSON.parse((typeof queryParams.touch3D == 'string') ? queryParams.touch3D : (product.viewer.touch3D != undefined) ? product.viewer.touch3D : false));

	if ( product.optional.transparent ) {moveSetting( ['viewer','transparent'], ['optional','transparent'] )}
	product.viewer.transparent = Boolean(JSON.parse((typeof queryParams.transparent == 'string') ? queryParams.transparent : (product.viewer.transparent != undefined) ? product.viewer.transparent : true));

	if ( product.gradient ) {moveSetting( ['viewer','gradient'], ['gradient'] )}
	product.viewer.gradient = Boolean(JSON.parse((typeof queryParams.gradient == 'string') ? queryParams.gradient : (product.viewer.gradient != undefined) ? product.viewer.gradient : true));

	if ( product.backgroundColor ) {moveSetting( ['viewer','backgroundColor'], ['backgroundColor'] )}
	product.viewer.backgroundColor = (typeof queryParams.backgroundColor == 'string') ? queryParams.backgroundColor : (product.viewer.backgroundColor != undefined) ? product.viewer.backgroundColor : "#a8a5a5";

	product.viewer.icon3D = Boolean(JSON.parse((typeof queryParams.icon3D == 'string') ? queryParams.icon3D : (product.viewer.icon3D != undefined) ? product.viewer.icon3D : false));


	// Camera
	if ( !product.camera ) { product.camera = {} }

	if ( product.defaultCam ) {product.camera.defaultCam = {}, moveSetting( ['camera','defaultCam'], ['defaultCam'] )}
	if ( typeof queryParams.defaultCam == 'string' ) queryParams.defaultCam = JSON.parse(decodeURI(queryParams.defaultCam));
	product.camera.defaultCam = (jQuery.isPlainObject(queryParams.defaultCam)) ? queryParams.defaultCam : (product.defaultCam) ? product.camera.defaultCam : {"x":2.7,"y":109,"z":427};

	if ( product.zoom ) {product.camera.zoom = {}, moveSetting( ['camera','zoom'], ['zoom'] )}
	product.camera.zoom.max = Number((typeof queryParams.maxZoom == 'string') ? queryParams.maxZoom : (product.camera.zoom.max != undefined) ? product.camera.zoom.max : 500);
	product.camera.zoom.min = Number((typeof queryParams.minZoom == 'string') ? queryParams.minZoom : (product.camera.zoom.min != undefined) ? product.camera.zoom.min : 100);

	if ( product.optional.fov ) {moveSetting( ['camera','fov'], ['optional','fov'] )}
	product.camera.fov = Number((typeof queryParams.fov == 'string') ? queryParams.fov : (product.camera.fov != undefined) ? product.camera.fov : 25);

	product.camera.orthographic = Boolean(JSON.parse((typeof queryParams.orthographic == 'string') ? queryParams.orthographic : (product.camera.orthographic != undefined) ? product.camera.orthographic : false));
	product.camera.disablePan = Boolean(JSON.parse((typeof queryParams.disablePan == 'string') ? queryParams.disablePan : (product.camera.disablePan != undefined) ? product.camera.disablePan : true));
	product.camera.disableZoom = Boolean(JSON.parse((typeof queryParams.disableZoom == 'string') ? queryParams.disableZoom : (product.camera.disableZoom != undefined) ? product.camera.disableZoom : false));
	product.camera.disableRotate = Boolean(JSON.parse((typeof queryParams.disableRotate == 'string') ? queryParams.disableRotate : (product.camera.disableRotate != undefined) ? product.camera.disableRotate : false));
	product.camera.maxPolarAngle = Number((typeof queryParams.maxPolarAngle == 'string') ? queryParams.maxPolarAngle : (product.camera.maxPolarAngle != undefined) ? product.camera.maxPolarAngle : 90);
	product.camera.minPolarAngle = Number((typeof queryParams.minPolarAngle == 'string') ? queryParams.minPolarAngle : (product.camera.minPolarAngle != undefined) ? product.camera.minPolarAngle : -90);


	// Lighting
	if ( !product.lighting ) { product.lighting = {} }

	product.lighting.groundShadow = Boolean(JSON.parse(( typeof queryParams.groundShadow == 'string' ) ? queryParams.groundShadow : ( product.lighting.groundShadow != undefined ) ? product.lighting.groundShadow : false));

	product.lighting.objectShadow = Boolean(JSON.parse(( typeof queryParams.objectShadow == 'string' ) ? queryParams.objectShadow : ( product.lighting.objectShadow != undefined ) ? product.lighting.objectShadow : false));
	if ( typeof queryParams.topShadow == 'string' && queryParams.topShadow == 'true' ) {
		product.lighting.groundShadow = true;
		product.lightingOptions.push({
			type: "directional",
			color: {r: 255, g: 255, b: 255},
			intensity: 0.0,
			position: {x: 0, y: 500, z: 0},
			castShadow: true
		})
	}

	if ( product.lightingOptions ) {product.lighting.lights = {}, moveSetting( ['lighting','lights'], ['lightingOptions'] )}
	if ( product.lighting.lights == undefined ) {
		product.lighting.lights = [{
			type: "ambient",
			color: {r: 255, g: 255, b: 255},
			intensity: 0.8
		},{
			type: "directional",
			color: {r: 255, g: 255, b: 255},
			intensity: 0.3,
			position: {x: 409, y: 357, z: 376}
		},{
			type: "directional",
			color: {r: 255, g: 255, b: 255},
			intensity: 0.3,
			position: {x: -309, y: 74, z: 136}
		},{
			type: "directional",
			color: {r: 255, g: 255, b: 255},
			intensity: 0.3,
			position: {x: -250, y: 0, z: -600}
		}]
	}
	for ( key in product.lighting.lights ) {
		if (product.lighting.lights[key].lightType) {
			product.lighting.lights[key].type = product.lighting.lights[key].lightType;
			delete product.lighting.lights[key].lightType;
		}
		if (product.lighting.lights[key].lightIntensity) {
			product.lighting.lights[key].intensity = product.lighting.lights[key].lightIntensity;
			delete product.lighting.lights[key].lightIntensity;
		}
		if (product.lighting.lights[key].lightPosition) {
			product.lighting.lights[key].position = product.lighting.lights[key].lightPosition;
			delete product.lighting.lights[key].lightPosition;
		}
	}


	// Model
	if ( !product.model ) { product.model = {} }

	if ( product.scale ) { moveSetting( ['model','scale'], ['scale'] )}
	product.model.scale = Number(( typeof queryParams.scale == 'string' ) ? queryParams.scale : ( product.model.scale != undefined ) ? product.model.scale : 4);

	if ( product.rotation ) { moveSetting( ['model','rotation'], ['rotation'] )}
	if ( typeof queryParams.rotation == 'string' ) queryParams.rotation = JSON.parse(decodeURI(queryParams.rotation));
	product.model.rotation = ( jQuery.isPlainObject(queryParams.rotation) ) ? queryParams.rotation : ( product.model.rotation ) ? product.model.rotation : {"x":0,"y":0,"z":0};


	pStat["ready"] = performance.now() - pStat["start"];

	if ( typeof queryParams.configHotspots == 'string' ) product.hotspots = JSON.parse(decodeURI(queryParams.configHotspots));
	if ( typeof product.hotspots == 'object' ) loadScript("_hotspots");

	if( product.viewer.hideInfo == false ) {
		$( '#bottom_bar' ).append("<div class='ui-icon'><img id='infoIcon' onclick='toggleInfoCard()' src='/images/info.png'></img><div>");
		$( '#3dinterface').append("<img id='infoCard' src='/images/info_card.png'></img><img id='infoCardMobile' src='/viewer/" + viewerVersion + "/images/info_card_mobile.png'></img>");
	}

	settingsUpdate('hideLogos','');
	settingsUpdate('hideFullscreen','');
	settingsUpdate('touch3D','');
	settingsUpdate('icon3D','');

	if ( product.viewer.transparent )
		settingsUpdate('background',{value:'transparent'});
	else if ( product.viewer.gradient )
		settingsUpdate('background',{value:'gradient'});
	else
		settingsUpdate('background',{value:'backgroundColor'});



	// else if( product.viewer.backgroundColor )
	//     if( product.viewer.gradient )
	//         $( '.container3d' ).css( 'background-color', product.viewer.backgroundColor );
	// else
	//     $( '.container3d' ).addClass( 'gradient' );

	if ( product.viewer.autoload ){
		$( '#btnLoad' ).remove();
		$( '#loader>img' ).css( 'display', 'block' );
		initProduct();
		renderLoop();
	} else {
		initPreview( mapMod );
		$( '#btnLoad' ).append("Click to Load Model");
		$( '#btnLoad' ).fadeIn();
	}

	$( '#fullScreenIcon' ).on( 'click', function(){
		// if (isFullscreen) {
		//     exitFullscreen();
		// } else {
			enableFullScreen();
		//}
	});


	function exitFullscreen() {
		if (document.exitFullscreen) {
			document.exitFullscreen();
		} else if (document.mozCancelFullScreen) {
			document.mozCancelFullScreen();
		} else if (document.webkitExitFullscreen) {
			document.webkitExitFullscreen();
		}
	}

	var toggleInfoCard = function () {
		if( window.TOUCH ) {
			if ($("#infoCardMobile").is(":visible"))
				$("#infoCardMobile").fadeOut('slow');
			else
				$("#infoCardMobile").fadeIn('slow');
		} else {
			if ($("#infoCard").is(":visible"))
				$("#infoCard").fadeOut('slow');
			else
				$("#infoCard").fadeIn('slow');
		}
	};

	$(document).mouseup(function (e) {
		if( window.TOUCH ) {
			var container = $("#infoCardMobile");

			if (($("#infoCardMobile").is(":visible"))) {
				$("#infoCardMobile").fadeOut('slow');
			}
			} else {
			var container = $("#infoCard");


			if (($("#infoCard").is(":visible"))) {
				$("#infoCard").fadeOut('slow');
			}
		}
	});

	$( '#btnLoad' ).on( 'click', function(){
		$( this ).fadeOut( 250, function(){
			$( this ).remove();
			$( '#loader>img' ).css( 'display', 'block' );
			initProduct();
			renderLoop();
		});
	});

	window.addEventListener('touchstart', function onFirstTouch() {
		window.TOUCH = true;
		window.removeEventListener('touchstart', onFirstTouch, false);
	}, false);

	var toggleIframeBackground = function() {
		$( '.container3d' ).toggleClass( 'gradent' );
	}

	$( '.btn-background' ).on( 'click', function(){
		if( !$( this ).hasClass( 'active' ) ) {
			$( '.btn-background.active' ).removeClass( 'active' );
			$( this ).addClass( 'active' );
			$( '.container3d' ).toggleClass( 'gradient' );
		}
	});

	$( '.container3d' ).on( 'touchstart mousedown', function(){
		isAnimated = false;
		orbitControls.autoRotate = false;
		$( '#ui' ).fadeOut( 350 );
	});

	$( '.container3d' ).on( 'touchend mouseup', function(){
		autospinDelay();
		$( '#ui' ).fadeIn( 350 );
		$(".comment-popup").removeClass("active");
		setTimeout(function() {
			$(".comment-popup").removeClass($(".comment-popup").data("position"))
			$(".comment-popup-mobile").removeClass("active");
		}, 200)
	} )

	$( window ).on( 'message', function(e){
		if( e.originalEvent.data !== 'loaded' ) {
			var commData = JSON.parse(e.originalEvent.data);
			if (queryParams.debug) {
				console.log('BAETES: Message received');
				console.log(commData);
			}
			switch (commData.type) {
				case 'interact':
					handleInteract( commData.func );
					break;
				case 'updateSettings':
					settingsUpdate( commData.data.setting, commData.data );
					break;
				case 'modify':
					if( commData.data == undefined ) {
						parent.postMessage( JSON.stringify({
							type: "error",
							message: "No data specified"
						}), '*' );
					} else {
						if( Array.isArray(commData.data) ) {
							for( edit in commData.data ) {
								switchModel( commData.data[edit] );
							}
						} else {
							switchModel( commData.data );
						}
					}
					break;
				case 'modifyCustom':
					if ( commData.data.part !== undefined && commData.data.path !== undefined ) {
						if ( commData.data.maskPath !== undefined ) {
							switchCustomMask( commData.data.part,commData.data.path,commData.data.maskPath, 512 );
						} else {
							switchCustomTexture( commData.data.part,commData.data.path );
						}
					}
					break;
				case 'lookup':
					lookupData = getData( commData.data );
					parent.postMessage( JSON.stringify({
						//type:   "lookup",
						//status: lookupData.status,
						data:   lookupData.data
					}), '*');
					console.log(lookupData.data);
					break;
				case 'moveCamera':
					if( commData.data !== undefined )
						tweenCameraTo(commData.data.x, commData.data.y, commData.data.z);
					break;
				case 'getCameraPos':
					console.log( "Camera position: \n\tx: " + Math.round(detailsCamera.position.x) +
						"\n\ty: " + Math.round(detailsCamera.position.y) +
						"\n\tz: " + Math.round(detailsCamera.position.z) );
					break;
				case 'autospinStart':
					orbitControls.autoRotate = true;
					renderLoop();
					break;
				case 'autospinStop':
					orbitControls.autoRotate = false;
					break;
				case 'updateText':
					if( Array.isArray(commData.data) ) {
						for( i=0; i<commData.data.length; i++ ) {
							textUpdate(
								commData.data[i].text,
								commData.data[i].font,
								commData.data[i].position,
								commData.data[i].albedo
							);
						}
					} else {
						textUpdate(
							commData.data.text,
							commData.data.font,
							commData.data.position,
							commData.data.albedo
						);
					}
					break;
				case 'moveParts':
					if( commData.data !== undefined ) {
						if( Array.isArray(commData.data) ) {
							for( movePartFunction in commData.data ) {
								processMovePart(commData.data[movePartFunction])
							}
						} else {
							if( commData.data.type == "reset" ) {
								if( commData.data.speed !== undefined && !isNaN(commData.data.speed) ) {
									resetPartPositions(commData.data.speed);
								} else {
									resetPartPositions(250);
								}
							} else {
								processMovePart(commData.data)
							}
						}
					}
					break;
				case 'configHotspots':
					if( commData.data !== undefined ) {
						product.hotspots = commData.data;
						loadScript("_hotspots");
					}
					break;
				case 'getSettings':
					parent.postMessage(JSON.stringify(product),"*");
					break;
				case 'initAR':
					if ( product.AR && product.AR.enable ) {

					} else {
						console.log('Warning: AR is not enabled for this product')
					}
					break;
			}
		}
	});
}

function enableFullScreen() {
	$('#3dcontainer').width('100%');
	$('#3dcontainer').height('100%');
	if(!window.TOUCH){
		enableFullScreenGL($('#3dinterface').get(0));
	} else {
		window.open( window.location.href, '_blank' );
		console.log( 'Fullscreen not supported' );
	}
}

function moveSetting ( target, source ) { // Move objects. Only supports 1 & 2 level nested source objects, and 2 level nested target objects.
	if ( source.length == 1 ) {
		if ( target.length == 2 ) {
			product[target[0]][target[1]] = product[source[0]]
			delete product[source[0]]
		}
	}
	else if ( source.length == 2 ) {
		if ( target.length == 2 ) {
				product[target[0]][target[1]] = product[source[0]][source[1]]
				delete product[source[0]][source[1]]
			}
	}
}

function onLoadUpdateUI() {
	$( '.container3d>canvas' ).animate( { 'opacity' : 1 }, 100, function(){
		$( '#loader' ).fadeOut( 500 );
		setTimeout(function(){$("#loader").remove()},500);
		$("#touchOverlay").load("/images/3Dtouch.html");
		$("#touchOverlay").css("opacity","0");
		$("#touchOverlay").animate({opacity: 1}, 1000, "linear");
		$("#viewerContainer").hover(
			function(){$("#touchOverlay").animate({opacity: 0}, 250, "linear")},
			function(){$("#touchOverlay").animate({opacity: 1}, 250, "linear")}
		);
		$("#viewerContainer").on('mousedown touchstart',function(){
			$("#touchOverlay").animate({opacity: 0}, {duration: 250, easing: "linear"});
			setTimeout(function(){$("#touchOverlay").remove()},500);
			$("#viewerContainer").off("mouseenter mouseleave");
			$("#viewerContainer").off("mousedown touchstart");
		})
		$( '#ui' ).fadeIn( 1000 );
		$( '#bottom_logo' ).fadeIn( 1000 );
	});
}
</script>
